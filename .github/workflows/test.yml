name: test

on:
  workflow_run:
    workflows: ["build"]
    types:
      - completed

env:
  REGISTRY_IMAGE: zhangdafei1995/my_ollvm

jobs:
  smoke:
    if: ${{ github.event_name == 'workflow_run' }}
    runs-on: ubuntu-latest
    env:
      IMAGE_REF: ${{ env.REGISTRY_IMAGE }}:sha-${{ github.event.workflow_run.head_sha }}
      RUN_SMOKE: >-
        ${{
          github.event.workflow_run.conclusion == 'success' &&
          github.event.workflow_run.event == 'push' &&
          startsWith(github.event.workflow_run.head_branch, 'v')
        }}
    steps:
      - name: Skip non-release runs
        if: ${{ env.RUN_SMOKE != 'true' }}
        run: echo "Skipping smoke tests for workflow_run ${GITHUB_RUN_ID} (not a v* release)."

      - name: Checkout
        if: ${{ env.RUN_SMOKE == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: ${{ env.RUN_SMOKE == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ env.RUN_SMOKE == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Pull image
        if: ${{ env.RUN_SMOKE == 'true' }}
        run: docker pull ${{ env.IMAGE_REF }}

      - name: Linux glibc and musl smoke tests
        if: ${{ env.RUN_SMOKE == 'true' }}
        run: >-
          docker run --rm -v ${{ github.workspace }}/tests:/tests
          ${{ env.IMAGE_REF }}
          bash -lc "set -euo pipefail;
          clang /tests/linux_glibc.c -O2 -o /tmp/linux_glibc && /tmp/linux_glibc;
          clang --target=x86_64-linux-musl --sysroot /usr/x86_64-linux-musl -static /tests/linux_glibc.c -O2 -o /tmp/linux_musl && /tmp/linux_musl"

      - name: Windows mingw smoke test
        if: ${{ env.RUN_SMOKE == 'true' }}
        run: >-
          docker run --rm -v ${{ github.workspace }}/tests:/tests
          ${{ env.IMAGE_REF }}
          bash -lc "set -euo pipefail;
          x86_64-w64-mingw32-clang /tests/windows_hello.c -O2 -o /tmp/hello.exe -luser32;
          llvm-readobj -file-headers /tmp/hello.exe | grep -q 'Machine: IMAGE_FILE_MACHINE_AMD64'"

      - name: Rust toolchain smoke tests
        if: ${{ env.RUN_SMOKE == 'true' }}
        run: >-
          docker run --rm -v ${{ github.workspace }}/tests:/tests
          ${{ env.IMAGE_REF }}
          bash -lc "set -euo pipefail;
          cd /tests/rust;
          cargo build --target x86_64-unknown-linux-musl --release;
          CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang cargo build --target x86_64-pc-windows-gnu --release"
