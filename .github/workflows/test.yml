name: test

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY_IMAGE: zhangdafei1995/my_ollvm
  TEST_TRIGGER_KEYWORDS: dotest
  TEST_IMAGE_TAG: latest

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine smoke trigger
        id: smoke
        run: |
          set -euo pipefail
          RUN_SMOKE=false
          EVENT="${GITHUB_EVENT_NAME:-}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"
          REF_NAME="${GITHUB_REF_NAME:-}"
          if [[ "$EVENT" == "push" && "$REF_TYPE" == "tag" && "$REF_NAME" == v* ]]; then
            RUN_SMOKE=true
          elif [[ "$EVENT" == "workflow_dispatch" ]]; then
            RUN_SMOKE=true
          else
            msg="$(git show -s --format=%B "${GITHUB_SHA}")"
            regex="$(printf '%s' "${TEST_TRIGGER_KEYWORDS:-}" | tr ' ' '|' )"
            if [[ -n "$regex" ]] && printf '%s\n' "$msg" | grep -Ei "$regex" >/dev/null; then
              RUN_SMOKE=true
            fi
          fi
          echo "run_smoke=$RUN_SMOKE" >> "$GITHUB_OUTPUT"

      - name: Skip non-release runs
        if: ${{ steps.smoke.outputs.run_smoke != 'true' }}
        run: echo "Skipping smoke tests for ${GITHUB_REF}; not a release tag or keyword-triggered commit."

      - name: Prepare artifact directory
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        run: |
          set -euo pipefail
          rm -rf artifacts
          mkdir -p artifacts

      - name: Set up Docker Buildx
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Pull image
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        run: docker pull ${{ env.REGISTRY_IMAGE }}:${{ env.TEST_IMAGE_TAG }}

      - name: Rust toolchain builds
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        run: >-
          docker run --rm
          -v ${{ github.workspace }}/tests:/tests
          -v ${{ github.workspace }}/artifacts:/artifacts
          ${{ env.REGISTRY_IMAGE }}:${{ env.TEST_IMAGE_TAG }}
          bash -lc "set -euo pipefail;
          cd /tests/rust;
          CARGO_BIN=\"/opt/cargo/bin/cargo\";
          if [ ! -x \"\$CARGO_BIN\" ]; then
            CARGO_BIN=\"\$(command -v cargo)\";
          fi;
          shopt -s nullglob;
          STUB_DIR=\"/tmp/mingw-compat-libs\";
          mkdir -p \"\$STUB_DIR\";
          CLANG_BUILTINS=\"\$(find /opt/llvm-mingw -name 'libclang_rt.builtins-x86_64.a' 2>/dev/null | head -n 1 || true)\";
          if [ -n \"\$CLANG_BUILTINS\" ]; then
            printf 'GROUP (%s)\\n' \"\$CLANG_BUILTINS\" > \"\$STUB_DIR/libgcc.a\";
          fi;
          UNWIND_LIB=\"\$(find /opt/llvm-mingw -name 'libunwind.a' 2>/dev/null | head -n 1 || true)\";
          if [ -n \"\$UNWIND_LIB\" ]; then
            printf 'GROUP (%s)\\n' \"\$UNWIND_LIB\" > \"\$STUB_DIR/libgcc_eh.a\";
          fi;
          MINGW_LIB_GCC=\"\$(x86_64-w64-mingw32-gcc -print-libgcc-file-name 2>/dev/null || x86_64-w64-mingw32-clang -print-libgcc-file-name 2>/dev/null || true)\";
          LIB_SEARCH_DIRS=();
          if [ -n \"\$MINGW_LIB_GCC\" ]; then
            LIB_SEARCH_DIRS+=( \"\$(dirname \"\$MINGW_LIB_GCC\")\" );
          fi;
          for candidate in /opt/llvm-mingw/lib/gcc/x86_64-w64-mingw32/*; do
            [[ -d \"\$candidate\" ]] || continue
            LIB_SEARCH_DIRS+=( \"\$candidate\" );
          done;
          [[ -d /opt/llvm-mingw/x86_64-w64-mingw32/lib ]] && LIB_SEARCH_DIRS+=(\"/opt/llvm-mingw/x86_64-w64-mingw32/lib\");
          [[ -d /opt/llvm-mingw/lib ]] && LIB_SEARCH_DIRS+=(\"/opt/llvm-mingw/lib\");
          LIB_SEARCH_DIRS+=(\"\$STUB_DIR\");
          RUSTFLAGS_MINGW='-Clink-self-contained=yes -Clink-arg=-fuse-ld=lld -Clink-arg=-Wl,-O2 -Clink-arg=-rtlib=compiler-rt -Clink-arg=-unwindlib=libunwind';
          if [ \"\${#LIB_SEARCH_DIRS[@]}\" -gt 0 ]; then
            LIB_PATH_VALUE=\"\";
            for candidate in \"\${LIB_SEARCH_DIRS[@]}\"; do
              [[ -d \"\$candidate\" ]] || continue
              RUSTFLAGS_MINGW=\"\$RUSTFLAGS_MINGW -Clink-arg=-L\$candidate\";
              if [ -z \"\$LIB_PATH_VALUE\" ]; then
                LIB_PATH_VALUE=\"\$candidate\";
              else
                LIB_PATH_VALUE=\"\$LIB_PATH_VALUE:\$candidate\";
              fi;
            done;
            if [ -n \"\$LIB_PATH_VALUE\" ]; then
              export LIBRARY_PATH=\"\$LIB_PATH_VALUE:\${LIBRARY_PATH:-}\";
            fi;
          fi;
          \"\$CARGO_BIN\" clean;
          env CC_x86_64_unknown_linux_musl=clang CFLAGS_x86_64_unknown_linux_musl='-mllvm -fla -mllvm -bcf' \"\$CARGO_BIN\" build --target x86_64-unknown-linux-musl --release;
          env CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang RUSTFLAGS=\"\$RUSTFLAGS_MINGW\" \"\$CARGO_BIN\" build --target x86_64-pc-windows-gnu --release;
          cp target/x86_64-unknown-linux-musl/release/ollvm-smoke /artifacts/rust-linux-musl;
          cp target/x86_64-pc-windows-gnu/release/ollvm-smoke.exe /artifacts/rust-windows.exe"

      - name: Linux glibc and musl build
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        run: >-
          docker run --rm
          -v ${{ github.workspace }}/tests:/tests
          -v ${{ github.workspace }}/artifacts:/artifacts
          ${{ env.REGISTRY_IMAGE }}:${{ env.TEST_IMAGE_TAG }}
          bash -lc "set -euo pipefail;
          mkdir -p /artifacts;
          clang -mllvm -fla -mllvm -bcf /tests/linux_glibc.c -O2 -o /artifacts/linux_glibc && /artifacts/linux_glibc;
          clang --target=x86_64-linux-musl -isystem /usr/include/x86_64-linux-musl -L/usr/lib/x86_64-linux-musl -static -mllvm -fla -mllvm -bcf /tests/linux_glibc.c -O2 -o /artifacts/linux_musl;
          /artifacts/linux_musl"

      - name: Windows mingw build
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        run: >-
          docker run --rm
          -v ${{ github.workspace }}/tests:/tests
          -v ${{ github.workspace }}/artifacts:/artifacts
          ${{ env.REGISTRY_IMAGE }}:${{ env.TEST_IMAGE_TAG }}
          bash -lc "set -euo pipefail;
          mkdir -p /artifacts;
          x86_64-w64-mingw32-clang -mllvm -sub -mllvm -bcf /tests/windows_hello.c -O2 -o /artifacts/windows_hello.exe -luser32;
          llvm-readobj --file-headers /artifacts/windows_hello.exe | grep -q 'Machine: IMAGE_FILE_MACHINE_AMD64'"

      - name: Upload artifacts
        if: ${{ steps.smoke.outputs.run_smoke == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ollvm-binaries-${{ github.sha }}
          path: artifacts
